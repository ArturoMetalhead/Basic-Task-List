{% extends "TaskListApp/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}TaskList{% endblock %}


{% block content %}



<div class="d-flex justify-content-center">
  <div style="width: 100%; max-width: 960px;">
    
    <form id="taskForm" method="post" action="{% url 'add_task' %}" class="task-box mb-4">
      {% csrf_token %}

      <!-- Input con ícono -->
      <div class="input-wrapper">
        <span id="plusToggle" class="plus-icon">
          <i data-feather="plus-square"></i>
        </span>
        <input type="text" name="title" id="taskInput"
               class="form-control task-input ps-5"
               placeholder="Type to add new task">
        <input type="hidden" name="task_id" id="taskIdInput" value="">
      </div>

      <!-- Botones debajo -->
      <div id="leftButtons" class="task-buttons fade-buttons d-flex justify-content-between align-items-center flex-nowrap gap-2">
        <div id="extraButtons" class="d-flex gap-2 overflow-auto">
          <!-- Botones extra -->
          <button type="button" class="task-button" disabled><i data-feather="maximize-2"></i> Open</button>
          <button type="button" class="task-button" disabled><i data-feather="calendar"></i> Today</button>
          <button type="button" class="task-button" disabled><i data-feather="lock"></i> Public</button>
          <button type="button" class="task-button" disabled><i data-feather="sun"></i> Highlight</button>
          <button type="button" class="task-button" disabled><i data-feather="circle"></i> Estimation</button>
        </div>
        <div class="btn-group-right d-flex gap-2">
          <button type="button" class="task-button btn-cancel" id="cancelBtn">Cancel</button>
          <button type="submit" class="task-button btn-ok" id="okBtn">Ok</button>

           <!-- botón unificado-->
           <button type="button" id="mobileActionBtn" class="task-button d-none">
            <i data-feather="x"></i>
          </button>

        </div>
      </div>
    </form>

    <!-- Lista de tareas -->
    <ul class="list-group">
      {% for task in tasks %}
        <li class="list-group-item d-flex align-items-center">
          <form method="post" action="{% url 'delete_task' task.id %}" onsubmit="return confirm('Delete this task?');" class="me-2">
            {% csrf_token %}
            <input type="checkbox" onchange="this.form.submit()" />
          </form>
          <span class="editable-task" data-id="{{ task.id }}">{{ task.title|highlight_tags }}</span>
        </li>
      {% empty %}
        <li class="list-group-item text-center">No tasks yet.</li>
      {% endfor %}
    </ul>

  </div>
</div>


<!-------------------SCRIPTS------------------>

<script>
  const input = document.getElementById('taskInput');
  const okBtn = document.getElementById('okBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const form = document.getElementById('taskForm');
  const leftButtonsContainer = document.getElementById('leftButtons');
  const leftButtons = document.querySelectorAll('#extraButtons button');
  const plusToggle = document.getElementById('plusToggle');
  let activeInlineEditor = null;
  


  const mobileActionBtn = document.getElementById('mobileActionBtn');
  let isTaskFilled = false;

  function updateButtons() {
    const isEmpty = input.value.trim() === "";
    const isMobile = window.innerWidth < 1230;

    if (isMobile) {
      // Mostrar solo el botón móvil
      mobileActionBtn.classList.remove('d-none');
      cancelBtn.classList.add('d-none');
      okBtn.classList.add('d-none');

      // Cambiar icono según si hay texto
      mobileActionBtn.innerHTML = `<i data-feather="${isEmpty ? 'x' : 'plus'}"></i>`;
      feather.replace();
    } else {
      // Mostrar botones normales
      mobileActionBtn.classList.add('d-none');
      cancelBtn.classList.remove('d-none');
      okBtn.classList.remove('d-none');

      // Actualizar estado
      okBtn.textContent = isEmpty ? "Ok" : "Add";
      cancelBtn.disabled = false;
    }

    // Activar/desactivar botones extra
    leftButtons.forEach(btn => {
      btn.disabled = isEmpty;
    });
  }

// Input listener
input.addEventListener('input', updateButtons);
window.addEventListener('resize', updateButtons); // actualizar al redimensionar

// Acción botón móvil
mobileActionBtn.addEventListener('click', () => {
  const isEmpty = input.value.trim() === "";
  if (isEmpty) {
    // Acción de cancel
    input.value = "";
    leftButtonsContainer.classList.remove('show');
    updateButtons();
  } else {
    // Acción de enviar
    form.submit();
  }
});

  // Mostrar botones al hacer foco en el input
  input.addEventListener('focus', () => {
    leftButtonsContainer.classList.add('show');
  });


  // Ocultar los botones si pierde foco y no hay texto
  input.addEventListener('blur', () => {
    setTimeout(() => {
      if (input.value.trim() === "") {
        leftButtonsContainer.classList.remove('show');
      }
    }, 100);
  });

  // Cancelar limpia el input y desactiva todo
  cancelBtn.addEventListener('click', () => {
    input.value = "";
    okBtn.textContent = "Ok";
    cancelBtn.disabled = false;
    leftButtons.forEach(btn => btn.disabled = true);
    leftButtonsContainer.classList.remove('show');
  });

  // Evita submit si está vacío
  form.addEventListener('submit', (e) => {
    if (input.value.trim() === "") {
      e.preventDefault();
    }
  });
   
  // Mostrar botones al hacer clic en el botón de más
  plusToggle.addEventListener('click', () => {
  if (!leftButtonsContainer.classList.contains('show')) {
    leftButtonsContainer.classList.add('show');
    input.focus();
  }
});


document.querySelectorAll('.editable-task').forEach(span => {
  span.addEventListener('click', () => {
    // Elimina cualquier editor abierto
    if (activeInlineEditor) {
      activeInlineEditor.remove();
      activeInlineEditor = null;
    }

    const taskText = span.textContent.trim();
    const taskId = span.getAttribute('data-id');

    // Crear nuevo contenedor
    const editor = document.createElement('div');
    editor.classList.add('task-box', 'inline-editor', 'mt-2');


    editor.innerHTML = `
  <form method="post" action="{% url 'add_task' %}" class="inline-edit-form">
    {% csrf_token %}
    <input type="hidden" name="task_id" value="${taskId}">
    <div class="input-wrapper">
      <input type="text" name="title" class="form-control task-input ps-5" value="${taskText}" autofocus>
    </div>

    <div class="task-buttons d-flex justify-content-between align-items-center flex-nowrap gap-2 mt-2">
      <div class="d-flex gap-2 overflow-auto extraButtons">
        <!-- Botones extra -->
        <button type="button" class="task-button" disabled><i data-feather="maximize-2"></i> Open</button>
        <button type="button" class="task-button" disabled><i data-feather="calendar"></i> Today</button>
        <button type="button" class="task-button" disabled><i data-feather="lock"></i> Public</button>
        <button type="button" class="task-button" disabled><i data-feather="sun"></i> Highlight</button>
        <button type="button" class="task-button" disabled><i data-feather="circle"></i> Estimation</button>
      </div>

      <div class="btn-group-right d-flex gap-2">
        <button type="button" class="task-button btn-cancel-inline">Cancel</button>
        <button type="submit" class="task-button btn-ok-inline">Ok</button>
        <button type="button" class="task-button d-none btn-mobile-inline">
          <i data-feather="save"></i>
        </button>
      </div>
    </div>
  </form>
`;

    span.parentElement.insertAdjacentElement('afterend', editor);
    feather.replace();

    // Elementos internos
const editForm = editor.querySelector('.inline-edit-form');
const titleInput = editForm.querySelector('input[name="title"]');
const cancelBtnInline = editForm.querySelector('.btn-cancel-inline');
const okBtnInline = editForm.querySelector('.btn-ok-inline');
const mobileBtnInline = editForm.querySelector('.btn-mobile-inline');
//const extraButtonsInline = editForm.querySelectorAll('.task-button[disabled]');


const extraButtonsInline = editForm.querySelectorAll('.extra-btn');


// Función para actualizar visibilidad según tamaño y contenido
function updateInlineButtons() {
  const isEmpty = titleInput.value.trim() === "";
  const isMobile = window.innerWidth < 1230;

  if (isMobile) {
    cancelBtnInline.classList.add('d-none');
    okBtnInline.classList.add('d-none');
    mobileBtnInline.classList.remove('d-none');

    mobileBtnInline.innerHTML = `<i data-feather="${isEmpty ? 'x' : 'save'}"></i>`;
    feather.replace();
  } else {
    cancelBtnInline.classList.remove('d-none');
    okBtnInline.classList.remove('d-none');
    mobileBtnInline.classList.add('d-none');
  }

  extraButtonsInline.forEach(btn => {
  btn.disabled = isEmpty;
  });
}

titleInput.addEventListener('input', updateInlineButtons);
window.addEventListener('resize', updateInlineButtons);
updateInlineButtons();

// Cancelar
cancelBtnInline.addEventListener('click', () => {
  editor.remove();
  activeInlineEditor = null;
});

// Botón móvil
mobileBtnInline.addEventListener('click', () => {
  const isEmpty = titleInput.value.trim() === "";
  if (isEmpty) {
    editor.remove();
    activeInlineEditor = null;
  } else {
    editForm.submit();
  }
});


    activeInlineEditor = editor;

    // Botón cancelar
    editor.querySelector('.btn-cancel-inline').addEventListener('click', () => {
      editor.remove();
      activeInlineEditor = null;
    });
  });
});

document.addEventListener('click', function (e) {
  if (
    activeInlineEditor &&
    !activeInlineEditor.contains(e.target) &&
    !e.target.classList.contains('editable-task')
  ) {
    activeInlineEditor.remove();
    activeInlineEditor = null;
  }
});

</script>
  
{% endblock %}